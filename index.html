<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="/manifest.webmanifest">
    <title>Notification Test Setup</title>
    <style type="text/css">
    body {
      background-color: #FF9800;
      color: black;
    }
    .vertical-alignment {
      height: 300px;
      text-align: center;
      display: -webkit-flex;
      display:         flex;
      -webkit-align-items: center;
              align-items: center;
      -webkit-justify-content: center;
              justify-content: center;
    }
    h1.vertical-alignment {
      font-size: 275%;
    }
    </style>
  </head>
  <body>
    <div class="vertical-alignment" id="container">
      <h1 >Hello World</h1>
      <button type="button" onclick="notifyMe()">Send Notification</button>
      <button type="button" onclick="sendNotification()">Send Notification</button>
      <input type="number" id="num_notifications" name="num_notifications" value="0" />
    </div>
    <script type="text/javascript">
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/worker.js').then(function(registration) {
            // Registration was successful
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }

      if (!!window.SharedWorker) {
        var worker = new SharedWorker('https://supp.dog/shared.js');

        work.port.onmessage = function(e) {
          console.log(e);
        }
      }

      for (let i = 2; i < 51; i += 1) {
        var iframe = document.createElement('iframe');
        iframe.setAttribute('id', `pwa${i}`);
        iframe.setAttribute('style', 'display:none');
        
        var container = document.getElementById('container');
        container.appendChild(iframe);
        iframe.setAttribute('src', `https://pwa${i}.supp.dog/index.html?id=${Date.now()}`);
      }

      function sendNotification() {
        console.log('sendNotifications invoked');

        worker.port.postMessage('Sending a message to the shared.js');

        var numMessage = document.getElementById("num_notifications");
        let messages = 0;
        if (numMessage && numMessage.value) {
          messages = parseInt(numMessage.value);
          console.log('messages to be sent:', messages);
        } else {
          console.log('numMessage is null:', numMessage);
          return;
        }

        var iframes = [...document.querySelectorAll('iframe')].sort(() => Math.random() - Math.random()).slice(0, messages);
        console.log('iframes identified:', iframes.length);

        iframes.forEach(iframe => {
          var win = iframe.contentWindow;
          console.log('postMessage to:', iframe.id);

          win.postMessage(JSON.stringify("sending random messages"));
        })
      }

      function notifyMe() {
        // Let's check if the browser supports notifications
        if (!("Notification" in window)) {
          alert("This browser does not support desktop notification");
        }

        // Let's check whether notification permissions have already been granted
        else if (Notification.permission === "granted") {
          // If it's okay let's create a notification
          var notification = new Notification("Hi there!");
        }

        // Otherwise, we need to ask the user for permission
        else if (Notification.permission !== "denied") {
          Notification.requestPermission().then(function (permission) {
            // If the user accepts, let's create a notification
            if (permission === "granted") {
              var notification = new Notification("Hi there!");
            }
          });
        }
      }
    </script>
  </body>
</html>
