<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="/manifest.webmanifest">
    <title>Notification Test Setup</title>
    <style type="text/css">
    body {
      background-color: #FF9800;
      color: black;
    }
    .vertical-alignment {
      height: 300px;
      text-align: center;
      display: -webkit-flex;
      display:         flex;
      -webkit-align-items: center;
              align-items: center;
      -webkit-justify-content: center;
              justify-content: center;
    }
    h1.vertical-alignment {
      font-size: 275%;
    }
    </style>
  </head>
  <body>
    <div class="vertical-alignment" id="container">
      <p>Enter a comma separated list of the PWA numbers you wish to notify (i.e. 2,5,6,7)</p>
      <button type="button" onclick="sendNotification()">Immediately Notify</button>
      <button type="button" onclick="sendNotification('interval')">Notify Randomly Staggered Intervals</button>
      <input type="text" id="which_pwa" name="which_pwa" value="0" />
    </div>
    <script type="text/javascript">
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/worker.js').then(function(registration) {
            // Registration was successful
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }

      function sendNotification(type) {
        let immediate = true;
        if (type && type === 'interval') {
          immediate = false;
        }

        console.log('sendNotifications invoked');

        const pwas_elem = document.getElementById('which_pwa');

        if (!pwas_elem || !pwas_elem.value) {
          console.log('no pwas identified');
          return;
        } 

        const pwas = pwas_elem.value.split(',');

        if (pwas.some(x => {
          try {
            parseInt(x);
          } catch(e) {
            return true;
          }
          return false;
        })) {
          console.log('not all elements are integers');
          return;
        }

        let timeout = 0;

        pwas.forEach(pwa_num => {
          if (!immediate) {
            timeout += parseInt(Math.random() * 10) * 1000;
          }
          console.log('setting cookie on pwa:', pwa_num, 'will set in', timeout, 'ms');
          setTimeout(function () {
            const cookie = `NOTIFICATION_${pwa_num}=notification from main;domain=.supp.dog;path=/;`
            document.cookie = cookie;
            console.log('cookie set as:', cookie);
          }, timeout);
        });
      }
    </script>
  </body>
</html>
